<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jersey Roots | Mobile Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(15, 23, 42, 0.85);
        }

        html, body, #root { height: 100%; overflow: hidden; background-color: #020617; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(22, 78, 99, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(76, 29, 149, 0.3) 0px, transparent 50%),
                url("https://www.transparenttextures.com/patterns/carbon-fibre.png");
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .glass-panel { 
            background: var(--glass-bg); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
        }

        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes { 0% { background-position: 1rem 0; } 100% { background-position: 0 0; } }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .snow-bg { background-color: #f1f5f9; background-image: url("https://www.transparenttextures.com/patterns/snow.png"); color: #0f172a; }
        .snow-bg .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0,0,0,0.1); color: #0f172a; }
        .snow-bg .text-white { color: #0f172a !important; }
        .snow-bg .text-slate-400 { color: #64748b !important; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkDUZZnh_AoKhBe-ntB1I4-QJKyiaEeg8",
            authDomain: "rollcall-e5e3a.firebaseapp.com",
            projectId: "rollcall-e5e3a",
            storageBucket: "rollcall-e5e3a.firebasestorage.app",
            messagingSenderId: "301776745476",
            appId: "1:301776745476:web:49d23434d590135c7df151"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- ICONS ---
        const IconWrapper = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Tractor: ({className}) => <IconWrapper className={className}><path d="M3 4h9l1 7h5.42A2.58 2.58 0 0 1 21 13.58v.57L16.85 18H12v-6H8v6H4.5A1.5 1.5 0 0 1 3 16.5V4z"/><circle cx="7" cy="18" r="2"/><circle cx="18" cy="18" r="2"/></IconWrapper>,
            Barn: ({className}) => <IconWrapper className={className}><path d="M22 22H2V10l10-8 10 8v12zM12 14v8M12 2v3"/><rect x="6" y="12" width="4" height="4"/><rect x="14" y="12" width="4" height="4"/></IconWrapper>,
            Silo: ({className}) => <IconWrapper className={className}><path d="M2 22v-5l5-5 5 5-5 5z"/><path d="M12 2v20"/><path d="M7 12h10"/></IconWrapper>,
            Users: ({className}) => <IconWrapper className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>,
            Fuel: ({className}) => <IconWrapper className={className}><path d="M6 22q2-2 2-8c0-3.6-1.5-5-2-5s-2 1.4-2 5q0 6 2 8"/><path d="M12 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 2v2"/><path d="M12 22v-2"/></IconWrapper>,
            Truck: ({className}) => <IconWrapper className={className}><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></IconWrapper>,
            Hammer: ({className}) => <IconWrapper className={className}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V2.75A2.75 2.75 0 0 0 16 0h-2.54a1 1 0 0 0-.76.35L1.08 13.08c-.6.6-.93 1.4-.93-2.25V2.75"/></IconWrapper>,
            Clock: ({className}) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>,
            Box: ({className}) => <IconWrapper className={className}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Bank: ({className}) => <IconWrapper className={className}><rect x="3" y="18" width="18" height="4" rx="1"/><rect x="3" y="3" width="18" height="4" rx="1"/><path d="M4 7v11"/><path d="M20 7v11"/><path d="M12 7v11"/><path d="M8 7v11"/><path d="M16 7v11"/></IconWrapper>,
            Wrench: ({className}) => <IconWrapper className={className}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>,
            Snow: ({className}) => <IconWrapper className={className}><path d="M2.5 2.5a.5.5 0 0 1 0 1 .5.5 0 0 1 0-1Zm19 0a.5.5 0 0 1 0 1 .5.5 0 0 1 0-1Zm-9.5 2a.5.5 0 0 1 0 1 .5.5 0 0 1 0-1Zm9.5 17a.5.5 0 0 1 0 1 .5.5 0 0 1 0-1Zm-19 0a.5.5 0 0 1 0 1 .5.5 0 0 1 0-1Z"/><path d="M12 2v20M2 12h20M4.93 4.93l14.14 14.14M4.93 19.07 19.07 4.93"/></IconWrapper>,
            List: ({className}) => <IconWrapper className={className}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            Home: ({className}) => <IconWrapper className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>,
            Map: ({className}) => <IconWrapper className={className}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></IconWrapper>,
            Dollar: ({className}) => <IconWrapper className={className}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></IconWrapper>,
            Cloud: ({className}) => <IconWrapper className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5c-1.45 0-2.748.59-3.714 1.541A5.496 5.496 0 0 0 6 13.5A5.506 5.506 0 0 0 11.5 19h6Z"/><path d="M17.5 19c2.485 0 4.5-2.015 4.5-4.5S19.985 10 17.5 10c-.16 0-.317.009-.471.025A5.5 5.5 0 0 0 12 5c-2.598 0-4.766 1.814-5.316 4.233A5.503 5.503 0 0 0 2 13.5C2 16.537 4.463 19 7.5 19h10Z"/></IconWrapper>,
            LogOut: ({className}) => <IconWrapper className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconWrapper>,
            Lock: ({className}) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
            Mail: ({className}) => <IconWrapper className={className}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></IconWrapper>,
            Trash: ({className}) => <IconWrapper className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></IconWrapper>,
            Save: ({className}) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>,
            Menu: ({className}) => <IconWrapper className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></IconWrapper>,
            X: ({className}) => <IconWrapper className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconWrapper>,
            Settings: ({className}) => <IconWrapper className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconWrapper>,
            Check: ({className}) => <IconWrapper className={className}><polyline points="20 6 9 17 4 12"></polyline></IconWrapper>
        };

        const DAY_MS = 86400000;
        const HOUR_MS = 3600000;
        const SAVE_KEY = 'jersey_roots_v26_7_STABLE'; 
        const CLOUD_COLLECTION = 'jersey_roots_saves';

        const SERVICE_INTERVAL = 24; 
        const SERVICE_COST = 1200; 
        const REPAIR_COST = 8500; 
        const WEAR_RATE = 2.0; 
        const OVERDUE_RATE = 6.0;
        const FUEL_PRICE = 3.65;
        const LAND_PRICE_PER_ACRE = 16500;
        const SNOW_JOB_TIME = 2 * HOUR_MS; 
        const FEED_PER_CHORE = 500; 

        const EQUIP_LEASE_RATE = 0.05; 
        const LAND_LEASE_RATE = 0.01;
        const BASE_FARM_TAX = 2000;
        const TAX_PER_ACRE = 25;

        const CROPS = { 'Corn': { name: 'Corn', color: 'bg-yellow-500', plantMonths: [3, 4, 5], steps: ['Primary Tillage', 'Lime', 'Fertilizer', 'Secondary Tillage', 'Plant', 'Harvest'], inputs: {seed:'seed_corn',seedRate:0.4,fert:0.2,lime:1}, equip:['Planter','Header_Corn'], yield:180, price:4.25 }, 'Soy': { name: 'Soy', color: 'bg-green-600', plantMonths: [4, 5, 6], steps: ['Primary Tillage', 'Lime', 'Secondary Tillage', 'Plant', 'Spray', 'Harvest'], inputs: {seed:'seed_soy',seedRate:1.0,fert:0,lime:0.5}, equip:['Planter','Header_Grain'], yield:55, price:11.40 }, 'Wheat': { name: 'Wheat', color: 'bg-amber-600', plantMonths: [8, 9, 10, 11], steps: ['Primary Tillage', 'Fertilizer', 'Secondary Tillage', 'Plant', 'Harvest'], inputs: {seed:'seed_wheat',seedRate:2.0,fert:0.15,lime:0}, equip:['Drill','Header_Grain'], yield:85, price:5.60, byproduct:'straw', byYield:1.5 }, 'Hay': { name: 'Alfalfa', color: 'bg-emerald-700', plantMonths: [3, 4, 8], steps: ['Primary Tillage', 'Lime', 'Secondary Tillage', 'Plant', 'Cut', 'Tedder', 'Bale'], inputs: {seed:'seed_hay',seedRate:0.5,fert:0.1,lime:1.5}, equip:['Drill','Mower','Baler'], yield:6, price:180 }, 'Cotton': { name: 'Cotton', color: 'bg-slate-200', plantMonths: [4, 5], steps: ['Primary Tillage', 'Fertilizer', 'Secondary Tillage', 'Plant', 'Spray', 'Harvest'], inputs: { seed: 'seed_cotton', seedRate: 0.2, fert: 0.25, lime:1 }, equip: ['Planter', 'Harvester_Cotton'], yield: 3, price: 85.00 }, 'Rice': { name: 'Rice', color: 'bg-cyan-700', plantMonths: [3, 5], steps: ['Primary Tillage', 'Fertilizer', 'Plant', 'Spray', 'Harvest'], inputs: { seed: 'seed_rice', seedRate: 1.5, fert: 0.4, lime:0 }, equip: ['Drill', 'Header_Grain'], yield: 160, price: 6.80 }, 'Potato': { name: 'Potatoes', color: 'bg-yellow-800', plantMonths: [3, 4], steps: ['Primary Tillage', 'De-Stone', 'Plant', 'Hilling', 'Spray', 'Harvest'], inputs: {seed:'seed_potato',seedRate:20,fert:0.5,lime:0}, equip:['Planter_Potato','Harvester_Potato'], yield:450, price:9.50 }, 'Peanuts': { name: 'Peanuts', color: 'bg-orange-800', plantMonths: [4, 5], steps: ['Tillage', 'Lime', 'Plant', 'Digging', 'Harvest'], inputs: {seed:'seed_peanut',seedRate:1,fert:0.2,lime:0.8}, equip:['Planter','Harvester_Peanut'], yield:4000, price:0.25 }, 'Beets': { name: 'Sugar Beets', color: 'bg-pink-900', plantMonths: [3, 4], steps: ['Tillage', 'Fertilizer', 'Plant', 'Harvest'], inputs: {seed:'seed_beet',seedRate:0.5,fert:0.4,lime:1}, equip:['Planter','Harvester_Beet'], yield:30, price:45.00 }, 'Canola': { name: 'Canola', color: 'bg-yellow-400', plantMonths: [7, 8], steps: ['Tillage', 'Fertilizer', 'Plant', 'Harvest'], inputs: {seed:'seed_canola',seedRate:0.3,fert:0.3,lime:0.5}, equip:['Drill','Header_Grain'], yield:45, price:13.50 }, 'Oats': { name: 'Oats', color: 'bg-amber-200', plantMonths: [2, 3], steps: ['Tillage', 'Plant', 'Harvest'], inputs: {seed:'seed_oats',seedRate:3,fert:0.1,lime:0}, equip:['Drill','Header_Grain'], yield:90, price:3.80 }, 'Barley': { name: 'Barley', color: 'bg-amber-300', plantMonths: [8, 10], steps: ['Tillage', 'Plant', 'Harvest'], inputs: {seed:'seed_barley',seedRate:2.5,fert:0.15,lime:0}, equip:['Drill','Header_Grain'], yield:80, price:5.10 }, 'Sorghum': { name: 'Sorghum', color: 'bg-orange-600', plantMonths: [4, 6], steps: ['Tillage', 'Fertilizer', 'Plant', 'Harvest'], inputs: {seed:'seed_sorghum',seedRate:0.4,fert:0.2,lime:0}, equip:['Planter','Header_Grain'], yield:110, price:6.20 }, 'Sunflower': { name: 'Sunflower', color: 'bg-yellow-300', plantMonths: [4, 6], steps: ['Tillage', 'Plant', 'Harvest'], inputs: {seed:'seed_sunflower',seedRate:0.3,fert:0.2,lime:0}, equip:['Planter','Header_Sunflower'], yield:1800, price:0.22 } };
        const BUILDINGS = { 'shed_s': { name: 'Small Machine Shed', cost: 65000, category: 'Storage', capacity: 5, buildTime: 14 * DAY_MS }, 'shed_l': { name: 'Large Machine Shed', cost: 150000, category: 'Storage', capacity: 15, buildTime: 30 * DAY_MS }, 'bin_s': { name: 'Grain Bin (10k bu)', cost: 45000, category: 'Storage', capacity: 10000, buildTime: 5 * DAY_MS }, 'bin_l': { name: 'Grain Bin (50k bu)', cost: 110000, category: 'Storage', capacity: 50000, buildTime: 14 * DAY_MS }, 'fuel_s': { name: 'Farm Fuel Tank (1k gal)', cost: 12500, category: 'Infrastructure', capacity: 1000, buildTime: 2 * DAY_MS }, 'fuel_l': { name: 'Fuel Depot (5k gal)', cost: 35000, category: 'Infrastructure', capacity: 5000, buildTime: 7 * DAY_MS }, 'barn': { name: 'Dairy Barn', cost: 450000, capacity: 200, category: 'Livestock', type: 'Livestock_Dairy', input: 'tmr', output: 'milk', buildTime: 90 * DAY_MS }, 'feedlot': { name: 'Beef Feedlot', cost: 120000, capacity: 100, category: 'Livestock', type: 'Livestock_Beef', input: 'corn', output: 'manure', buildTime: 45 * DAY_MS }, 'hog': { name: 'Hog Barn', cost: 250000, capacity: 1000, category: 'Livestock', type: 'Livestock_Hog', input: 'corn', output: 'manure', buildTime: 60 * DAY_MS }, 'coop': { name: 'Chicken Coop', cost: 85000, capacity: 5000, category: 'Livestock', type: 'Livestock_Poultry', input: 'wheat', output: 'eggs', buildTime: 30 * DAY_MS }, 'pasture': { name: 'Sheep Pasture', cost: 25000, capacity: 100, category: 'Livestock', type: 'Livestock_Sheep', input: 'hay', output: 'wool', buildTime: 7 * DAY_MS } };
        const ANIMALS = { 'cow': { name: 'Holstein', cost: 1800, building: 'Livestock_Dairy', dailyFeed: 50, dailyWater: 30, dailyStraw: 10, productRate: 0.8 }, 'steer': { name: 'Angus', cost: 1100, building: 'Livestock_Beef', dailyFeed: 40, dailyWater: 25, dailyStraw: 8 }, 'pig': { name: 'Hog', cost: 150, building: 'Livestock_Hog', dailyFeed: 6, dailyWater: 4, dailyStraw: 1 }, 'hen': { name: 'Hen', cost: 5, building: 'Livestock_Poultry', dailyFeed: 0.25, dailyWater: 0.1, dailyStraw: 0, productRate: 0.9 }, 'sheep': { name: 'Sheep', cost: 250, building: 'Livestock_Sheep', dailyFeed: 4, dailyWater: 2, dailyStraw: 1, productRate: 0.05 } };
        const EQUIPMENT = [ 
            { id: 'jd_8r', name: 'JD 8R 340', cost: 410000, cat: 'Tractor' }, 
            { id: 'cih_mag', name: 'Case IH 310', cost: 385000, cat: 'Tractor' }, 
            { id: 'cih_rip', name: 'Ripper 875', cost: 95000, cat: 'Plow' }, 
            { id: 'jd_vt', name: 'Vertical Till', cost: 125000, cat: 'Cultivator' }, 
            { id: 'jd_plnt', name: 'JD 1775NT', cost: 215000, cat: 'Planter' }, 
            { id: 'gp_drl', name: 'Grain Drill', cost: 85000, cat: 'Drill' }, 
            { id: 'pot_plnt', name: 'Potato Planter', cost: 65000, cat: 'Planter_Potato' }, 
            { id: 'jd_x9', name: 'JD X9 Combine', cost: 850000, cat: 'Combine' }, 
            { id: 'cot_pick', name: 'Cotton Picker', cost: 950000, cat: 'Harvester_Cotton' }, 
            { id: 'pot_harv', name: 'Potato Harv', cost: 450000, cat: 'Harvester_Potato' }, 
            { id: 'beet_harv', name: 'Beet Harv', cost: 650000, cat: 'Harvester_Beet' }, 
            { id: 'pnut_harv', name: 'Peanut Harv', cost: 180000, cat: 'Harvester_Peanut' }, 
            { id: 'hd_corn', name: 'Corn Header', cost: 95000, cat: 'Header_Corn' }, 
            { id: 'hd_grain', name: 'Draper Header', cost: 110000, cat: 'Header_Grain' }, 
            { id: 'hd_sun', name: 'Sun Header', cost: 65000, cat: 'Header_Sunflower' }, 
            { id: 'mix', name: 'TMR Mixer', cost: 85000, cat: 'Mixer' }, 
            { id: 'tank', name: 'Water Tanker', cost: 25000, cat: 'Tanker' }, 
            { id: 'proc', name: 'Bale Proc', cost: 45000, cat: 'Processor' }, 
            { id: 'destone', name: 'De-Stoner', cost: 85000, cat: 'De-Stone' }, 
            { id: 'dig', name: 'Peanut Digger', cost: 45000, cat: 'Digger_Peanut' }, 
            { id: 'mow', name: 'Mower', cost: 55000, cat: 'Mower' }, 
            { id: 'bale', name: 'Baler', cost: 165000, cat: 'Baler' }, 
            { id: 'sprd', name: 'Spreader', cost: 45000, cat: 'Spreader' }, 
            { id: 'spry', name: 'Sprayer', cost: 499000, cat: 'Sprayer' }, 
            { id: 'plow_snow', name: 'Snow Plow', cost: 12000, cat: 'Snow Plow' }, 
            { id: 'salt_sprd', name: 'Salt Spreader', cost: 8500, cat: 'Salt Spreader' },
            { id: 'washer', name: 'Pressure Washer', cost: 2500, cat: 'Washer' },
            { id: 'mower_ride', name: 'Zero Turn Mower', cost: 12000, cat: 'LawnMower' },
            { id: 'skid', name: 'Skid Steer', cost: 45000, cat: 'SkidSteer' },
            { id: 'truck', name: 'Service Truck', cost: 65000, cat: 'Truck' },
            { id: 'g_trailer', name: 'Grain Trailer', cost: 55000, cat: 'Trailer' }
        ];
        const SUPPLIES = { 'seed_corn': 320, 'seed_soy': 74, 'seed_wheat': 28, 'seed_hay': 210, 'seed_cotton': 650, 'seed_rice': 35, 'seed_potato': 18, 'seed_beet': 180, 'seed_canola': 450, 'seed_sunflower': 280, 'seed_oats': 18, 'seed_barley': 22, 'seed_sorghum': 150, 'seed_peanut': 90, 'fert': 750, 'lime': 45, 'tmr': 250, 'straw': 100, 'salt': 80 };
        const EMP_ROLES = { 'Hand': { name: 'Farm Hand', wage: 20, desc: 'Field Operations' }, 'Herd': { name: 'Herdsman', wage: 25, desc: 'Livestock Care' }, 'Mech': { name: 'Mechanic', wage: 35, desc: 'Maintenance' }, 'Vet': { name: 'Vet Specialist', wage: 60, desc: 'Animal Health' } };
        const ROLE_NAMES = { 'Hand': ["Caleb D.", "Wyatt E.", "Luke S.", "Beau T.", "Tucker J.", "Hank R.", "Dusty M.", "Clay B."], 'Herd': ["Clara M.", "Annie P.", "Gus H.", "Shep L.", "Colt R.", "Daisy F.", "Walker T.", "Tex S."], 'Mech': ["Mac D.", "Axel R.", "Rod S.", "Gage T.", "Smitty W.", "Diesel J.", "Rusty B.", "Sparky M."], 'Vet': ["Dr. Smith", "Dr. Wells", "Dr. Grey", "Dr. House", "Dr. Quinn", "Dr. Stone", "Dr. Drake", "Dr. Cole"] };

        const MISC_JOBS = [
            { id: 'manure', name: 'Scrape Alleys (Manure)', freq: 'Daily', role: 'Hand', req: 'SkidSteer', dur: 1800000 },
            { id: 'bin', name: 'Monitor Bin Temp', freq: 'Daily', role: 'Mech', req: null, dur: 900000 },
            { id: 'shop', name: 'Shop Cleanup', freq: 'Daily', role: 'Hand', req: null, dur: 1800000 },
            { id: 'fence', name: 'Fence Repair', freq: 'Weekly', role: 'Hand', req: 'Truck', dur: 7200000 },
            { id: 'wash', name: 'Wash Equipment', freq: 'Weekly', role: 'Mech', req: 'Washer', dur: 3600000 },
            { id: 'mow', name: 'Mow Grounds', freq: 'Weekly', role: 'Hand', req: 'LawnMower', seasonal: true, dur: 5400000 },
            { id: 'rock', name: 'Pick Rocks (Field)', freq: 'Weekly', role: 'Hand', req: 'Truck', seasonal: true, dur: 10800000 }
        ];

        const BUYERS = ["Garden State Ethanol", "Trenton Mills", "Newark Exports", "BioFuel Sys", "Jersey Feeds", "Atlantic Grain", "Camden Processing", "Liberty Logistics", "Princeton Bio", "Shoreline Foods"];

        // --- HELPERS (Global) ---
        const getEq = (id) => EQUIPMENT.find(e => e.id === id);
        
        // Helper to name supplies nicely in the store
        const getSupplyName = (key) => {
            if(key === 'fert') return 'Fertilizer';
            if(key === 'lime') return 'Lime';
            if(key === 'tmr') return 'TMR Feed';
            if(key === 'straw') return 'Straw Bales';
            if(key === 'salt') return 'Road Salt';
            if(key.startsWith('seed_')) {
                const cropName = key.replace('seed_', '');
                return cropName.charAt(0).toUpperCase() + cropName.slice(1) + ' Seeds';
            }
            return key.toUpperCase();
        };

        // --- AUTH GATE COMPONENT ---
        const AuthGate = ({ onLogin, error }) => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [isRegister, setIsRegister] = useState(false);

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                try {
                    if (isRegister) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch(err) { alert(err.message); }
            };

            const handleGoogle = async () => {
                try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch(err) { alert(err.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-[#020617]">
                    <div className="glass-panel p-8 max-w-md w-full animate-fade-in text-center">
                        <div className="mb-6 flex justify-center">
                            <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                                <Icons.Tractor className="text-white w-10 h-10"/>
                            </div>
                        </div>
                        <h1 className="text-3xl font-black text-white mb-2 tracking-tight">JERSEY ROOTS</h1>
                        <p className="text-slate-400 text-sm mb-8">Cloud Edition: Play Anywhere</p>

                        <button onClick={handleGoogle} className="w-full bg-white text-slate-900 font-bold py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-200 transition-colors mb-6">
                            <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Continue with Google
                        </button>

                        <div className="relative mb-6">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-white/10"></div></div>
                            <div className="relative flex justify-center text-xs uppercase"><span className="bg-[#0f172a] px-2 text-slate-500">Or use email</span></div>
                        </div>

                        <form onSubmit={handleEmailAuth} className="space-y-4 text-left">
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-500 ml-1">Email</label>
                                <div className="relative"><Icons.Mail className="w-5 h-5 absolute left-3 top-3 text-slate-500"/><input type="email" required value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-slate-900 border border-white/10 rounded-xl py-3 pl-10 pr-3 text-white focus:outline-none focus:border-blue-500"/></div>
                            </div>
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-500 ml-1">Password</label>
                                <div className="relative"><Icons.Lock className="w-5 h-5 absolute left-3 top-3 text-slate-500"/><input type="password" required value={pass} onChange={e=>setPass(e.target.value)} className="w-full bg-slate-900 border border-white/10 rounded-xl py-3 pl-10 pr-3 text-white focus:outline-none focus:border-blue-500"/></div>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg">{isRegister ? 'Create Account' : 'Sign In'}</button>
                        </form>
                        <button onClick={()=>setIsRegister(!isRegister)} className="mt-4 text-sm text-blue-400 hover:text-white transition-colors">{isRegister ? 'Have an account? Sign In' : 'Need an account? Register'}</button>
                    </div>
                </div>
            );
        };

        // --- FIXED DROPDOWN COMPONENT ---
        const RenderSelect = ({ label, categories, selected, onChange, inventory, activeJobs }) => {
            const isBusy = (uid) => (activeJobs||[]).some(j => j.res.includes(uid));
            const available = (inventory || []).filter(i => {
                const def = getEq(i.itemId);
                return def && !isBusy(i.uid) && categories.includes(def.cat);
            });
            const missing = available.length === 0;
            return (
                <div>
                    <label className="text-[10px] text-slate-500 uppercase font-bold mb-1 block">
                        {label} <span className="text-slate-600">({categories.join('/')})</span>
                    </label>
                    <select 
                        className={`w-full p-3 rounded-lg text-sm outline-none border ${missing ? 'bg-red-900/20 border-red-500 text-red-300' : 'bg-slate-900 border-slate-700 text-white'}`}
                        onChange={(e) => onChange(e.target.value)}
                        value={selected || ""}
                        disabled={missing}
                    >
                        <option value="">{missing ? `MISSING: ${categories[0]}` : "-- Select --"}</option>
                        {available.map(i => {
                            const def = getEq(i.itemId);
                            return (
                                <option key={i.uid} value={i.uid}>{def ? def.name : 'Unknown'} ({i.ownership==='leased'?'L':'O'})</option>
                            );
                        })}
                    </select>
                </div>
            );
        };

        // --- MOBILE NAV COMPONENT ---
        const MobileNav = ({ currentView, setView, menuOpen, setMenuOpen }) => {
            const mainItems = [
                { id: 'dashboard', icon: Icons.Home, label: 'Dash' },
                { id: 'livestock', icon: Icons.Barn, label: 'Barn' },
                { id: 'jobs', icon: Icons.List, label: 'Jobs' },
                { id: 'store', icon: Icons.Box, label: 'Shop' },
                { id: 'realestate', icon: Icons.Map, label: 'Map' }
            ];
            
            return (
                <>
                    {menuOpen && (
                        <div className="fixed inset-0 bg-black/80 z-40 backdrop-blur-sm flex flex-col justify-end pb-24 animate-fade-in" onClick={() => setMenuOpen(false)}>
                            <div className="bg-slate-900 border-t border-white/10 p-4 rounded-t-2xl space-y-2 mb-safe" onClick={e => e.stopPropagation()}>
                                {['market', 'garage', 'bank', 'hr', 'storage'].map(id => (
                                    <button key={id} onClick={() => { setView(id); setMenuOpen(false); }} className="w-full p-4 rounded-xl bg-slate-800 text-white font-bold flex items-center gap-4 hover:bg-blue-600 transition-colors">
                                        {id === 'market' && <Icons.Dollar className="w-6 h-6 text-emerald-400"/>}
                                        {id === 'garage' && <Icons.Wrench className="w-6 h-6 text-orange-400"/>}
                                        {id === 'bank' && <Icons.Bank className="w-6 h-6 text-yellow-400"/>}
                                        {id === 'hr' && <Icons.Users className="w-6 h-6 text-blue-400"/>}
                                        {id === 'storage' && <Icons.Box className="w-6 h-6 text-purple-400"/>}
                                        <span className="capitalize">{id}</span>
                                    </button>
                                ))}
                                {/* Added Settings Button */}
                                <button onClick={() => { setView('settings'); setMenuOpen(false); }} className="w-full p-4 rounded-xl bg-slate-800 text-white font-bold flex items-center gap-4 hover:bg-red-900/50 transition-colors border border-red-500/20">
                                    <Icons.Settings className="w-6 h-6 text-red-400"/>
                                    <span>Settings</span>
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 h-20 bg-slate-900/95 backdrop-blur-xl border-t border-white/10 flex justify-around items-center z-50 pb-safe lg:hidden shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                        {mainItems.map(item => (
                            <button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-all ${currentView === item.id ? 'text-blue-400 scale-110' : 'text-slate-500 hover:text-white'}`}>
                                <item.icon className="w-6 h-6" />
                                <span className="text-[10px] font-bold">{item.label}</span>
                            </button>
                        ))}
                        <button onClick={() => setMenuOpen(!menuOpen)} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-all ${menuOpen ? 'text-white' : 'text-slate-500'}`}>
                            <Icons.Menu className="w-6 h-6" />
                            <span className="text-[10px] font-bold">More</span>
                        </button>
                    </div>
                </>
            );
        };

        function App() {
            const isResetting = useRef(false);
            const [fuelAmount, setFuelAmount] = useState(100);
            const [sellAmount, setSellAmount] = useState(0);
            
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isCloudSaving, setIsCloudSaving] = useState(false);

            const [gameState, setGameState] = useState(null); 
            const [now, setNow] = useState(Date.now());
            const [view, setView] = useState('dashboard');
            const [modal, setModal] = useState(null);
            const [storeTab, setStoreTab] = useState('eq');
            const [menuOpen, setMenuOpen] = useState(false); 

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setCurrentUser(user);
                        try {
                            const cloudRef = db.collection(CLOUD_COLLECTION).doc(user.uid);
                            const doc = await cloudRef.get();
                            const localStr = localStorage.getItem(SAVE_KEY);
                            let localData = localStr ? JSON.parse(localStr) : null;
                            let finalData = null;
                            const cloudData = doc.exists ? doc.data() : null;

                            if (cloudData && localData) {
                                const cloudTime = cloudData.lastSaveTime || 0;
                                const localTime = localData.lastSaveTime || 0;
                                finalData = cloudTime > localTime ? cloudData : localData;
                            } else if (cloudData) {
                                finalData = cloudData;
                            } else if (localData) {
                                finalData = localData;
                            } else {
                                finalData = getInitialState();
                            }
                            setGameState(finalData);
                        } catch(e) { console.error("Load Error", e); setGameState(getInitialState()); }
                    } else {
                        setCurrentUser(null);
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // --- SEPARATE SAVE LOOP (Does not affect Game Loop) ---
            useEffect(() => {
                if (!currentUser || !gameState) return;
                const saveInterval = setInterval(() => {
                    if(isResetting.current) return;
                    setIsCloudSaving(true);
                    const stateWithTime = { ...gameState, lastSaveTime: Date.now() };
                    localStorage.setItem(SAVE_KEY, JSON.stringify(stateWithTime));
                    db.collection(CLOUD_COLLECTION).doc(currentUser.uid).set(stateWithTime)
                        .then(() => setTimeout(() => setIsCloudSaving(false), 1000))
                        .catch(e => console.error("Cloud Save Fail", e));
                }, 30000); 
                return () => clearInterval(saveInterval);
            }, [gameState, currentUser]);

            const forceCloudSave = async () => {
                if(!currentUser || !gameState) return;
                setIsCloudSaving(true);
                const stateWithTime = { ...gameState, lastSaveTime: Date.now() };
                localStorage.setItem(SAVE_KEY, JSON.stringify(stateWithTime));
                await db.collection(CLOUD_COLLECTION).doc(currentUser.uid).set(stateWithTime);
                setTimeout(() => setIsCloudSaving(false), 1000);
                alert("Game Saved to Cloud!");
            };

            const getInitialState = () => {
                const initialTasks = MISC_JOBS.map(j => ({...j, status: 'Due', lastDone: 0}));
                return {
                    money: 6000000, 
                    loan: 0, 
                    inventory: [], 
                    activeJobs: [], 
                    construction: [], 
                    deliveries: [],
                    transactions: [],
                    employees: [{id:1, name:'Owner', hourlyRate:0, role:'Owner', status:'Idle'}],
                    lastPayroll: null,
                    miscTasks: initialTasks,
                    lastDayReset: 0,
                    lastWeekReset: 0,
                    lastTaxMonth: -1,
                    contracts: [],
                    activeContracts: [],
                    facilities: [
                        {id:'start', key:'shed_s', type:'Storage', category:'Storage', animals:null},
                        {id:'fuelstart', key:'fuel_s', type:'Infrastructure', category:'Infrastructure', animals:null}
                    ],
                    consumables: { 'diesel': 500 }, 
                    fields: Array.from({length: 50}, (_, i) => ({ id:i+1, owned: i<3, acres: Math.floor(Math.random()*300)+50, state: 'Fallow', cropPlan: null })),
                    weather: 'Clear',
                    snowLevel: 0,
                    lastSaveTime: Date.now()
                };
            };

            const handleLogout = () => { auth.signOut(); window.location.reload(); };

            const hardReset = async () => {
                if(!confirm("⚠️ ARE YOU SURE? ⚠️\n\nThis will wipe your farm from the cloud permanently. You will start over.")) return;
                isResetting.current = true;
                setIsCloudSaving(true);
                const newState = getInitialState();
                localStorage.removeItem(SAVE_KEY);
                if(currentUser) {
                    try { await db.collection(CLOUD_COLLECTION).doc(currentUser.uid).set(newState); setGameState(newState); alert("Farm has been reset successfully."); } 
                    catch(e) { alert("Error resetting cloud save: " + e.message); }
                } else { setGameState(newState); }
                setIsCloudSaving(false);
                isResetting.current = false;
            };

            const getSeasonalPrice = (cropKey, basePrice, month) => {
                let mod = 1.0;
                if(cropKey === 'Corn' && [9,10,11].includes(month)) mod = 0.8; 
                if(cropKey === 'Corn' && [5,6,7].includes(month)) mod = 1.2; 
                if(cropKey === 'Wheat' && [6,7].includes(month)) mod = 0.8;
                if(cropKey === 'Wheat' && [0,1].includes(month)) mod = 1.2;
                if(cropKey === 'Soy' && [9,10].includes(month)) mod = 0.85;
                return basePrice * mod * (0.95 + Math.random() * 0.1);
            };

            const generateContract = () => {
                const cropKey = Object.keys(CROPS)[Math.floor(Math.random() * Object.keys(CROPS).length)];
                const crop = CROPS[cropKey];
                const buyer = BUYERS[Math.floor(Math.random() * BUYERS.length)];
                const qty = Math.floor(Math.random() * 50000) + 5000;
                const price = crop.price * (1.1 + Math.random() * 0.2);
                const days = Math.floor(Math.random() * 65) + 300; 
                return { id: Math.random(), buyer, crop: cropKey, qty, price, deadline: Date.now() + (days * DAY_MS), delivered: 0, penalty: (qty * price) * 0.5 };
            };

            useEffect(() => {
                // Weather Loop
                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=40.05&longitude=-74.40&current=weather_code,temperature_2m&timezone=America%2FNew_York');
                        const data = await res.json();
                        if(data && data.current && typeof data.current.weather_code === 'number') {
                            const code = data.current.weather_code;
                            let w = 'Clear';
                            if([71,73,75,77,85,86].includes(code)) w = 'Snow';
                            else if([51,53,55,61,63,65,80,81,82].includes(code)) w = 'Rain';
                            setGameState(prev => {
                                if(!prev) return prev;
                                let newSnow = (prev.snowLevel || 0);
                                if(w === 'Snow') newSnow = Math.min(100, newSnow + 5); 
                                else if(w === 'Rain') newSnow = Math.max(0, newSnow - 10); 
                                else if(data.current.temperature_2m > 0) newSnow = Math.max(0, newSnow - 1); 
                                return { ...prev, weather: w, snowLevel: newSnow };
                            });
                        }
                    } catch(e) { console.log("Weather API Error (ignoring)"); }
                };
                fetchWeather();
                const wInterval = setInterval(fetchWeather, 900000);
                return () => clearInterval(wInterval);
            }, []);

            useEffect(() => {
                // Main Game Loop - Only runs if logged in
                if (!currentUser) return;

                const t = setInterval(() => {
                    const ct = Date.now();
                    const dateObj = new Date(ct);
                    const dayNum = dateObj.getDate();
                    setNow(ct);
                    
                    setGameState(prev => {
                        if(!prev) return null; // Prevents crash on empty state
                        
                        let { money, loan, activeJobs, facilities, consumables, employees, fields, deliveries, inventory, construction, lastPayroll, transactions, snowLevel, weather, miscTasks, lastDayReset, lastWeekReset, lastTaxMonth, contracts, activeContracts } = prev;
                        contracts = contracts || [];
                        activeContracts = activeContracts || [];
                        deliveries = deliveries || [];
                        activeJobs = activeJobs || [];
                        facilities = facilities || [];

                        // ... Daily Reset Logic ...
                        if(dayNum !== lastDayReset) {
                            contracts = Array.from({length: 5}, () => generateContract());
                            miscTasks = miscTasks.map(t => t.freq === 'Daily' ? {...t, status: 'Due'} : t);
                            lastDayReset = dayNum;
                        }
                        if(dateObj.getDay() === 1 && dayNum !== lastWeekReset) {
                             miscTasks = miscTasks.map(t => {
                                if(t.freq === 'Weekly') {
                                    if(t.seasonal && (dateObj.getMonth() < 3 || dateObj.getMonth() > 10 || snowLevel > 5)) return {...t, status: 'Skipped'};
                                    return {...t, status: 'Due'};
                                }
                                return t;
                            });
                            lastWeekReset = dayNum;
                        }
                        
                        // Contract Expiry
                        activeContracts = activeContracts.filter(c => {
                            if(ct > c.deadline) {
                                transactions = [{id: ct, desc: `Breach: ${c.buyer} Lawsuit`, amount: -c.penalty, date: ct}, ...transactions].slice(0,50);
                                money -= c.penalty;
                                return false; 
                            }
                            return true;
                        });
                        
                        // Payroll (Weekly)
                        const dateString = dateObj.toLocaleDateString();
                        if(dateObj.getDay() === 5 && lastPayroll !== dateString) {
                            let totalPayroll = 0;
                            // 40 hours reg + 10 hours overtime (1.5x)
                            employees.forEach(e => { if(e.id !== 1) totalPayroll += (e.hourlyRate * 40) + (e.hourlyRate * 1.5 * 10); });
                            if(totalPayroll > 0) {
                                if(money >= totalPayroll) { money -= totalPayroll; transactions = [{id: ct, desc: `Payroll (50h/wk)`, amount: -totalPayroll, date: ct}, ...transactions].slice(0, 50); } 
                                else { const deficit = totalPayroll - money; money = 0; loan += deficit; transactions = [{id: ct, desc: `Payroll Loan`, amount: -totalPayroll, date: ct}, ...transactions].slice(0, 50); }
                                lastPayroll = dateString; 
                            }
                        }

                        // Tax & Interest (Monthly)
                        const currentMonth = dateObj.getMonth();
                        if (currentMonth !== lastTaxMonth && lastTaxMonth !== -1) { 
                             // Calculate Tax
                             const ownedAcres = fields.filter(f => f.owned).reduce((sum, f) => sum + f.acres, 0);
                             const taxBill = BASE_FARM_TAX + (ownedAcres * TAX_PER_ACRE);
                             
                             // Calculate Interest (1% Monthly)
                             const interest = loan > 0 ? loan * 0.01 : 0;
                             const totalMonthlyBill = taxBill + interest;

                             if(money >= totalMonthlyBill) { 
                                 money -= totalMonthlyBill; 
                                 transactions = [{id: ct, desc: `Taxes & Interest`, amount: -totalMonthlyBill, date: ct}, ...transactions].slice(0, 50); 
                             } else { 
                                 const deficit = totalMonthlyBill - money; 
                                 money = 0; 
                                 loan += deficit; 
                                 transactions = [{id: ct, desc: `Tax/Interest (Added to Loan)`, amount: -totalMonthlyBill, date: ct}, ...transactions].slice(0, 50); 
                             }
                             lastTaxMonth = currentMonth;
                        }
                        if(lastTaxMonth === -1) lastTaxMonth = currentMonth;

                        let jobs = [], finished = [], jobMoney = 0;
                        const finConst = construction.filter(c => ct >= c.endTime);
                        finConst.forEach(c => {
                            const def = BUILDINGS[c.key];
                            facilities.push({ id: c.id, key: c.key, type: def.type, category: def.category, animals: null, feed:0, water:0, straw:0, manure:0, output:0 });
                        });
                        const pendingConst = construction.filter(c => ct < c.endTime);

                        const arrivedDel = deliveries.filter(d => ct >= d.at);
                        arrivedDel.forEach(d => {
                            if(d.type === 'eq') {
                                inventory.push({uid:Math.random().toString(36).substr(2,9), itemId:d.id, fuel: 100, hours:0, condition:100, lastService:0, ownership: d.mode === 'lease' ? 'leased' : 'owned'});
                            } else if(d.type === 'anim') {
                                facilities = facilities.map(f => f.id === d.targetId ? { ...f, animals: { type: f.animals ? f.animals.type : d.id, count: (f.animals ? f.animals.count : 0) + d.qty } } : f);
                            } else {
                                consumables = { ...consumables, [d.id]: (consumables[d.id]||0) + d.qty };
                            }
                        });
                        const pendingDel = deliveries.filter(d => ct < d.at);

                        // Process Active Jobs
                        activeJobs.forEach(j => {
                            if(ct - j.start >= j.dur) { finished.push(j); } 
                            else { 
                                jobs.push(j);
                                j.res.forEach(resId => {
                                    inventory = inventory.map(item => {
                                        if(item.uid === resId && item.hours !== undefined) {
                                            const newHours = (item.hours || 0) + (1/60);
                                            const hoursSinceService = newHours - (item.lastService || 0);
                                            const rate = hoursSinceService > SERVICE_INTERVAL ? OVERDUE_RATE : WEAR_RATE;
                                            const newCond = Math.max(0, (item.condition || 100) - (rate * (1/60) * 0.01));
                                            return { ...item, hours: newHours, condition: newCond };
                                        }
                                        return item;
                                    });
                                });
                            }
                        });

                        finished.forEach(j => {
                            try {
                                employees = employees.map(e => (e.id == j.emp || e.id == j.emp2) ? {...e, status:'Idle'} : e);
                                if(j.type === 'maintenance') inventory = inventory.map(i => i.uid === j.tid ? { ...i, condition: 100, lastService: i.hours } : i);
                                if(j.type === 'snow') snowLevel = 0; 
                                if(j.type === 'misc') miscTasks = miscTasks.map(t => t.id === j.tid ? {...t, status:'Done', lastDone: ct} : t);
                                if(j.type === 'field') {
                                    fields = fields.map(f => {
                                        if(f.id === j.tid) {
                                            if(j.step === 'Harvest') {
                                                const crop = CROPS[f.cropPlan.key];
                                                const yieldAmt = f.acres * crop.yield;
                                                consumables[f.cropPlan.key.toLowerCase()] = (consumables[f.cropPlan.key.toLowerCase()]||0) + yieldAmt;
                                                return { ...f, state: 'Stubble', cropPlan: null };
                                            }
                                            const ni = f.cropPlan.idx + 1;
                                            return { ...f, state: CROPS[f.cropPlan.key].steps[ni]||'Growing', cropPlan: {...f.cropPlan, idx: ni} };
                                        }
                                        return f;
                                    });
                                }
                                if(j.type === 'chore') {
                                    facilities = facilities.map(fac => {
                                        if(fac.id == j.tid) {
                                            if(j.task === 'feed') return {...fac, feed: Math.min(100, (fac.feed||0)+100)}; 
                                            if(j.task === 'water') return {...fac, water: Math.min(100, (fac.water||0)+100)};
                                            if(j.task === 'straw') return {...fac, straw: Math.min(100, (fac.straw||0)+100)};
                                            if(j.task === 'sell') { jobMoney += fac.output * 20; return {...fac, output: 0}; }
                                        }
                                        return fac;
                                    });
                                }
                            } catch(err) { console.error("Job Completion Error (Recovered):", err); }
                        });

                        // Animal Logic (Safe Update)
                        facilities = facilities.map(f => {
                            if(!f.animals) return f;
                            const def = ANIMALS[f.animals.type];
                            if (!def) return f;
                            const c = f.animals.count;
                            let consumption = 0.01; 
                            if(f.animals.type === 'hen') consumption = 0.0005; 
                            if(f.animals.type === 'sheep') consumption = 0.002; 
                            if(f.animals.type === 'pig') consumption = 0.0025; 
                            if(f.animals.type === 'steer') consumption = 0.008; 
                            const decay = consumption * c;
                            
                            // Prevent NaN
                            let currentFeed = f.feed || 0;
                            let currentWater = f.water || 0;
                            let currentStraw = f.straw || 0;
                            let currentOutput = f.output || 0;

                            let feed = Math.max(0, currentFeed - decay); 
                            let water = Math.max(0, currentWater - (decay*1.2)); 
                            let straw = Math.max(0, currentStraw - (decay*0.5));
                            let out = currentOutput;
                            
                            if(feed > 0 && water > 0) out += (def.productRate ? def.productRate*c*0.005 : 0);
                            
                            if ((feed <= 0 || water <= 0) && c > 0) {
                                if(Math.random() < 0.005) { // Slower death rate
                                    f.animals.count -= 1;
                                    transactions.unshift({id: Date.now(), desc: `Loss: ${def.name} died (Neglect)`, amount: 0, date: Date.now()});
                                }
                            }
                            if(f.animals.count <= 0) f.animals = null;
                            return {...f, feed, water, straw, output: out};
                        });

                        if(jobMoney > 0) transactions = [{id: ct, desc: 'Income', amount: jobMoney, date: ct}, ...transactions].slice(0, 50);
                        return { ...prev, money: money+jobMoney, loan, fields, facilities, activeJobs: jobs, construction: pendingConst, employees, deliveries: pendingDel, inventory, consumables, lastPayroll, transactions, weather, snowLevel, miscTasks, lastDayReset, lastWeekReset, lastTaxMonth, contracts, activeContracts, lastSaveTime: prev.lastSaveTime };
                    });
                }, 1000);
                return () => clearInterval(t);
            }, [currentUser]); // <-- IMPORTANT: Loop only restarts if User changes, not on every GameState change

            const getEq = (id) => EQUIPMENT.find(e => e.id === id);
            const isBusy = (uid) => (gameState.activeJobs||[]).some(j => j.res.includes(uid));
            const formatTime = (ms) => {
                const totalSec = Math.floor(ms / 1000);
                const d = Math.floor(totalSec / 86400); 
                const h = Math.floor((totalSec % 86400) / 3600);
                const m = Math.floor((totalSec % 3600) / 60);
                if (d > 0) return `${d}d ${h}h`;
                if (h > 0) return `${h}h ${m}m`;
                return `0h ${m}m`;
            };
            const getStorageStats = () => {
                let cropUsed = 0; Object.keys(CROPS).forEach(k => cropUsed += (gameState.consumables[k.toLowerCase()]||0));
                let grainCap = 0, machineCap = 0, fuelCap = 0;
                (gameState.facilities||[]).forEach(f => {
                    const def = BUILDINGS[f.key];
                    if(def && def.category === 'Storage') { if(def.type === 'Silo') grainCap += def.capacity; else machineCap += def.capacity; }
                    if(def && def.category === 'Infrastructure') fuelCap += def.capacity;
                });
                if(grainCap === 0) grainCap = 5000; if(fuelCap === 0) fuelCap = 100;
                return { cropUsed, grainCap, machineCap, machineUsed: (gameState.inventory||[]).length, fuelCap };
            };
            const getHRRequirements = () => {
                let acres = 0; (gameState.fields||[]).filter(f=>f.owned).forEach(f => acres += f.acres);
                let animalCount = 0; (gameState.facilities||[]).forEach(f => { if(f.animals) animalCount += f.animals.count; });
                return { 'Hand': Math.max(1, Math.ceil(acres / 300)), 'Herd': animalCount > 0 ? Math.ceil(animalCount / 50) : 0, 'Mech': Math.max(0, Math.ceil(gameState.inventory.length / 10)), 'Vet': animalCount > 0 ? 1 : 0 };
            };

            const getJobProgress = (id) => {
                const job = gameState.activeJobs.find(j => j.tid === id);
                if(!job) return null;
                const pct = Math.min(100, Math.max(0, ((now - job.start) / job.dur) * 100));
                const emp = gameState.employees.find(e => e.id == job.emp);
                return { pct, empName: emp ? emp.name : 'Worker', step: job.step || job.task };
            };

            const startJob = (d) => {
                const { type, tid, tr, imp, emp, dur, step, task, tr2, imp2, emp2 } = d;
                let updatedConsumables = { ...gameState.consumables };
                if(type === 'chore') {
                    const fac = gameState.facilities.find(f => f.id === tid);
                    const bldg = BUILDINGS[fac.key];
                    let res = null;
                    if(task === 'feed') res = bldg.input; 
                    else if(task === 'straw') res = 'straw';
                    if(res) {
                        if((updatedConsumables[res] || 0) < FEED_PER_CHORE) return alert(`Not enough ${res.toUpperCase()}!`);
                        updatedConsumables[res] -= FEED_PER_CHORE;
                    }
                }
                let finalDur = dur || 10000;
                if(type === 'field') {
                    const f = gameState.fields.find(fd => fd.id === tid);
                    let rate = 20; 
                    if(step.includes('Tillage')) rate = 12; else if(step === 'Plant') rate = 24; else if(step === 'Harvest') rate = 16; else if(step === 'Spray') rate = 90; 
                    finalDur = (f.acres / rate) * HOUR_MS; 
                } else if(type === 'chore') finalDur = 1800000; 
                else if(type === 'maintenance') finalDur = 3600000;
                else if(type === 'snow') finalDur = SNOW_JOB_TIME;

                setGameState(prev => {
                    let newTasks = prev.miscTasks;
                    if(type === 'misc') newTasks = newTasks.map(t => t.id === tid ? {...t, status:'Working'} : t);
                    let updatedEmps = prev.employees.map(e => e.id == (emp||1) ? {...e, status:'Working'} : e);
                    if(emp2) updatedEmps = updatedEmps.map(e => e.id == emp2 ? {...e, status:'Working'} : e);
                    return {
                        ...prev, 
                        miscTasks: newTasks,
                        consumables: updatedConsumables,
                        money: type === 'maintenance' ? prev.money - (step === 'Repair' ? REPAIR_COST : SERVICE_COST) : prev.money,
                        transactions: type === 'maintenance' ? [{id:Date.now(), desc:`Maint (${step})`, amount: -(step === 'Repair' ? REPAIR_COST : SERVICE_COST), date:Date.now()}, ...prev.transactions].slice(0,50) : prev.transactions,
                        employees: updatedEmps,
                        inventory: prev.inventory.map(i => (i.uid === tr || i.uid === tr2) ? {...i, fuel: Math.max(0, i.fuel - 20)} : i),
                        activeJobs: [...prev.activeJobs, { id: Math.random(), type, tid, step, emp: (emp||1), emp2: emp2, task, start: Date.now(), dur: finalDur, res: [tr, imp, tr2, imp2].filter(Boolean) }]
                    }
                });
                setModal(null);
            };

            const sellSpot = (crop) => {
                const amount = parseFloat(sellAmount);
                if(isNaN(amount) || amount <= 0) return alert("Invalid amount");
                const currentStock = gameState.consumables[crop.toLowerCase()] || 0;
                if(amount > currentStock) return alert("Not enough in silo!");
                const currentMonth = new Date(now).getMonth();
                const price = getSeasonalPrice(crop, CROPS[crop].price, currentMonth);
                const revenue = amount * price;
                setGameState(prev => ({
                    ...prev,
                    money: prev.money + revenue,
                    consumables: {...prev.consumables, [crop.toLowerCase()]: currentStock - amount},
                    transactions: [{id:Date.now(), desc: `Sold ${amount} ${crop}`, amount: revenue, date:Date.now()}, ...prev.transactions]
                }));
                setModal(null);
            };
            const signContract = (c) => {
                setGameState(prev => ({ ...prev, contracts: prev.contracts.filter(x => x.id !== c.id), activeContracts: [...prev.activeContracts, c] }));
            };
            const deliverContract = (cId, amount) => {
                const c = gameState.activeContracts.find(x => x.id === cId);
                const currentStock = gameState.consumables[c.crop.toLowerCase()] || 0;
                const actualAmount = Math.min(amount, currentStock, c.qty - c.delivered);
                if(actualAmount <= 0) return alert("Nothing to deliver or contract full.");
                const newDelivered = c.delivered + actualAmount;
                const finished = newDelivered >= c.qty;
                setGameState(prev => {
                    let newMoney = prev.money;
                    let newTrans = prev.transactions;
                    let newConsumables = {...prev.consumables, [c.crop.toLowerCase()]: currentStock - actualAmount};
                    let newActive = prev.activeContracts.map(x => x.id === cId ? {...x, delivered: newDelivered} : x);
                    if(finished) {
                        const payout = c.qty * c.price;
                        newMoney += payout;
                        newTrans = [{id:Date.now(), desc: `Contract Paid: ${c.buyer}`, amount: payout, date:Date.now()}, ...newTrans];
                        newActive = newActive.filter(x => x.id !== cId); 
                        alert(`Contract Completed! Earned $${payout.toLocaleString()}`);
                    }
                    return { ...prev, money: newMoney, transactions: newTrans, consumables: newConsumables, activeContracts: newActive };
                });
            };
            const refillTractor = (uid) => {
                const tr = gameState.inventory.find(i => i.uid === uid);
                const needed = 100 - tr.fuel;
                if(gameState.consumables.diesel < 10) return alert("Fuel Depot Empty!");
                const amount = Math.min(needed, gameState.consumables.diesel);
                setGameState(prev => ({ ...prev, consumables: {...prev.consumables, diesel: prev.consumables.diesel - amount}, inventory: prev.inventory.map(i => i.uid === uid ? {...i, fuel: i.fuel + amount} : i) }));
            };
            const buy = (item, type, qty=1) => { 
                const cost = type==='eq'?item.cost:item.val*qty; if(gameState.money<cost) return alert("Funds");
                const itemName = item.name || item.key;
                setGameState(prev=>({ ...prev, money:prev.money-cost, deliveries:[...prev.deliveries, {id:item.id||item.key, name:itemName, type, qty, at:Date.now()+5000}], transactions: [{id:Date.now(), desc: `Bought ${itemName} (x${qty})`, amount: -cost, date:Date.now()}, ...prev.transactions] })); 
            };
            const buyFuel = () => {
                const cost = fuelAmount * FUEL_PRICE; if(gameState.money<cost) return alert("Funds");
                setGameState(prev=>({ ...prev, money:prev.money-cost, deliveries:[...prev.deliveries, {id:'diesel',name:'Diesel',type:'sup',qty:parseFloat(fuelAmount),at:Date.now()+5000}], transactions: [{id:Date.now(), desc: `Refuel (${fuelAmount}gal)`, amount: -cost, date:Date.now()}, ...prev.transactions] })); setModal(null);
            };
            
            // --- BUNDLE LOGIC ---
            const buyBundle = (type) => {
                if(type === 'ultimate') {
                    if(!confirm("This Starter Pack will RESET your farm. You will get 10 fields, every machine type, and $5,000 cash. Continue?")) return;
                    
                    // Create one of every machine type
                    const starterFleet = [];
                    const addedCats = new Set();
                    EQUIPMENT.forEach(e => {
                        if(!addedCats.has(e.cat)) {
                            starterFleet.push({
                                uid: Math.random().toString(36).substr(2,9), 
                                itemId: e.id, 
                                fuel: 100, 
                                hours: 0, 
                                condition: 100, 
                                lastService: 0, 
                                ownership: 'owned'
                            });
                            addedCats.add(e.cat);
                        }
                    });

                    setGameState(prev => ({
                        ...prev,
                        money: 5000,
                        inventory: starterFleet,
                        // Set fields 1-10 to owned
                        fields: prev.fields.map(f => f.id <= 10 ? {...f, owned:true, leased:false} : {...f, owned:false}),
                        // Reset debt
                        loan: 0,
                        transactions: [{id:Date.now(), desc: 'Starter Pack Activated', amount: 0, date:Date.now()}]
                    }));
                    alert("Starter Pack Activated! Check your Garage and Fields.");
                }
            };

            const buyField = (fid) => {
                 const f = gameState.fields.find(f=>f.id===fid); const cost=f.acres*16500; if(gameState.money<cost) return alert("Funds");
                 setGameState(prev=>({ ...prev, money:prev.money-cost, fields:prev.fields.map(x=>x.id===fid?{...x, owned:true}:x), transactions: [{id:Date.now(), desc: `Property #${fid} (${f.acres}ac)`, amount: -cost, date:Date.now()}, ...prev.transactions] }));
            };
            const hire = (r) => {
                const names = ROLE_NAMES[r];
                const name = names[Math.floor(Math.random()*names.length)];
                setGameState(p=>({...p, employees:[...p.employees, {id:Date.now(), name, role:r, hourlyRate:20, status:'Idle'}]}));
            };
            const fireEmployee = (id) => setGameState(p=>({...p, employees:p.employees.filter(e=>e.id!==id)}));
            const loanOp = (a) => setGameState(p=>({ ...p, money:p.money+a, loan:p.loan+a, transactions: [{id:Date.now(), desc: a > 0 ? `Loan Taken` : `Loan Repayment`, amount: a, date:Date.now()}, ...p.transactions] }));
            const buyAnim = (fid, k, n) => {
                 const cost = ANIMALS[k].cost*n; if(gameState.money<cost) return alert("Funds");
                 setGameState(p=>({ ...p, money:p.money-cost, deliveries:[...p.deliveries, {type:'anim', targetId:fid, id:k, name:ANIMALS[k].name, qty:n, at:Date.now()+5000}], transactions: [{id:Date.now(), desc: `Bought ${n} ${ANIMALS[k].name}`, amount: -cost, date:Date.now()}, ...p.transactions] })); setModal(null);
            };
            const lease = (item) => { 
                const cost = item.cost * EQUIP_LEASE_RATE; if(gameState.money < cost) return alert("Funds");
                setGameState(prev => ({ ...prev, money: prev.money - cost, deliveries: [...prev.deliveries, { id: item.id, name: item.name, type: 'eq', qty: 1, at: Date.now() + 5000, mode: 'lease' }], transactions: [{id:Date.now(), desc:`Lease Down Pmt: ${item.name}`, amount:-cost, date:Date.now()}, ...prev.transactions] }));
            };
            const leaseField = (fid) => { 
                const f = gameState.fields.find(x => x.id === fid); const cost = (f.acres * LAND_PRICE_PER_ACRE) * LAND_LEASE_RATE; if(gameState.money < cost) return alert("Funds");
                setGameState(prev => ({ ...prev, money: prev.money - cost, fields: prev.fields.map(x => x.id === fid ? { ...x, owned: true, leased: true } : x), transactions: [{id:Date.now(), desc:`Lease Field #${fid}`, amount:-cost, date:Date.now()}, ...prev.transactions] }));
            };
            const startChore = () => {
                if(!modal.selectedTR || !modal.selectedEmp) return alert("Missing Equipment/Staff");
                startJob({ type: 'chore', tid: modal.fid, task: modal.job, tr: modal.selectedTR, imp: modal.selectedImp, emp: modal.selectedEmp });
            };
            const startMiscJob = () => {
                const job = MISC_JOBS.find(j => j.id === modal.jobId);
                if(job.req && !modal.selectedTR) return alert("Missing Equipment");
                if(!modal.selectedEmp) return alert("Missing Staff");
                startJob({ type: 'misc', tid: modal.jobId, tr: modal.selectedTR, emp: modal.selectedEmp, dur: job.dur });
            };
            const startMaintenance = () => {
                if(!modal.selectedEmp) return alert("Select Mechanic");
                startJob({ type: 'maintenance', tid: modal.tid, step: 'Service', tr: modal.tid, emp: modal.selectedEmp });
            };
            const startFieldJob = (fid, cropKey) => {
                const f = gameState.fields.find(fd=>fd.id===fid);
                let step = f.state;
                if(step==='Fallow'||step==='Stubble') step='Primary Tillage';
                if(step==='Ready') step='Harvest';
                if(step==='Harvest') {
                    if(!modal.selectedTR || !modal.selectedImp || !modal.selectedEmp || !modal.selectedTR2 || !modal.selectedImp2 || !modal.selectedEmp2) return alert("Missing Equipment");
                    startJob({type:'field', tid:fid, step, tr:modal.selectedTR, imp:modal.selectedImp, emp:modal.selectedEmp, tr2:modal.selectedTR2, imp2:modal.selectedImp2, emp2:modal.selectedEmp2});
                } else {
                    startJob({type:'field', tid:fid, step, tr:modal.selectedTR, imp:modal.selectedImp, emp:modal.selectedEmp});
                }
            };

            const getJobRequirements = (type, step, cropKey) => {
                let req = { trCat:['Tractor'], impCat:[], role:['Owner'], needsTransport: step==='Harvest' };
                if(type==='field') {
                    req.role.push('Hand');
                    if(step.includes('Primary Tillage')) req.impCat = ['Plow', 'Ripper', 'De-Stoner', 'Digger_Peanut'];
                    else if(step.includes('Secondary Tillage')) req.impCat = ['Cultivator'];
                    else if(step === 'Lime' || step === 'Fertilizer') req.impCat = ['Spreader'];
                    else if(step === 'Plant') {
                        if(cropKey === 'Corn' || cropKey === 'Soy' || cropKey === 'Cotton' || cropKey === 'Sunflower' || cropKey === 'Sorghum' || cropKey === 'Peanuts' || cropKey === 'Beets') req.impCat = ['Planter'];
                        else if(cropKey === 'Potato') req.impCat = ['Planter_Potato'];
                        else req.impCat = ['Drill']; 
                    }
                    else if(step === 'Spray') { req.trCat = ['Sprayer']; req.impCat = []; }
                    else if(step === 'Harvest') {
                        req.trCat = ['Combine'];
                        if(['Cotton'].includes(cropKey)) req.trCat = ['Harvester_Cotton'];
                        if(['Potato'].includes(cropKey)) req.trCat = ['Harvester_Potato'];
                        if(['Beets'].includes(cropKey)) req.trCat = ['Harvester_Beet'];
                        if(['Peanuts'].includes(cropKey)) req.trCat = ['Harvester_Peanut'];
                        
                        if(req.trCat.includes('Combine')) {
                            if(cropKey === 'Corn') req.impCat = ['Header_Corn'];
                            else if(cropKey === 'Sunflower') req.impCat = ['Header_Sunflower'];
                            else req.impCat = ['Header_Grain'];
                        } else {
                             req.impCat = [];
                        }
                    }
                    else if(step === 'Cut') { req.trCat = ['Tractor', 'Mower']; req.impCat = ['Mower']; } 
                    else if(step === 'Tedder') { req.impCat = ['Tedder']; } 
                    else if(step === 'Bale') { req.impCat = ['Baler']; }
                } 
                else if(type === 'chore') {
                    req.role.push('Herd'); 
                    req.trCat = ['Tractor']; 
                    if(step === 'feed') req.impCat = ['Mixer'];
                    else if(step === 'water') req.impCat = ['Tanker'];
                    else if(step === 'straw') req.impCat = ['Processor'];
                } 
                else if(type === 'maintenance') {
                    req.role.push('Mech'); 
                }
                else if(type === 'snow') {
                    req.role.push('Hand'); 
                    req.trCat = ['Snow Plow'];
                }
                else if(type === 'misc') {
                    const job = MISC_JOBS.find(j => j.id === step);
                    if(job) {
                         req.role.push(job.role);
                         if(job.req) req.trCat = [job.req]; else req.trCat = [];
                    }
                }
                return req;
            };

            // --- RENDER FUNCTIONS ---
            const renderDash = () => (
                <div className={`space-y-6 pb-safe ${gameState.snowLevel>0?'snow-bg':''} ${gameState.weather==='Rain'?'rain-bg':''}`}>
                    <div className="lg:hidden sticky top-0 z-30 bg-slate-900/95 backdrop-blur border-b border-white/10 -mx-4 -mt-4 p-4 mb-4 flex justify-between items-center shadow-lg">
                         <div>
                            <div className="text-2xl font-black text-emerald-400">${Math.floor(gameState.money).toLocaleString()}</div>
                            <div className="text-xs text-slate-400">{new Date(now).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} • {gameState.weather}</div>
                         </div>
                         <button onClick={forceCloudSave} className={`w-3 h-3 rounded-full ${isCloudSaving ? 'bg-orange-500 animate-pulse' : 'bg-green-500'}`}></button>
                    </div>

                    <div className="hidden lg:flex justify-between items-center glass-panel p-6 bg-gradient-to-r from-blue-900/40 to-slate-900/40 border-b border-white/5">
                        <div className="flex gap-6 items-center">
                            <div className="p-3 bg-blue-500/20 rounded-xl"><Icons.Clock className="w-8 h-8 text-blue-400" /></div>
                            <div>
                                <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">{new Date(now).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</h2>
                                <div className="text-slate-400 font-mono text-sm flex items-center gap-2">
                                    {new Date(now).toLocaleDateString()} 
                                    <span className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-blue-300 border border-blue-900">NJ: {gameState.weather}</span>
                                </div>
                            </div>
                        </div>
                        <div className="text-right">
                             <div className="text-2xl font-bold text-emerald-400">${Math.floor(gameState.money).toLocaleString()}</div>
                             {gameState.loan > 0 && <div className="text-xs text-red-400 font-mono">LOAN: ${Math.floor(gameState.loan).toLocaleString()}</div>}
                             <button onClick={forceCloudSave} className="mt-2 text-[10px] bg-slate-800 hover:bg-white/10 text-white px-2 py-1 rounded flex items-center justify-end gap-2 ml-auto border border-white/10">
                                <span className={`w-2 h-2 rounded-full ${isCloudSaving ? 'bg-orange-500 animate-pulse' : 'bg-green-500'}`}></span>
                                {isCloudSaving ? 'SAVING...' : 'FORCE CLOUD SAVE'}
                             </button>
                        </div>
                    </div>

                    {gameState.snowLevel > 0 && (
                        <div className="bg-blue-900/80 p-4 rounded-xl flex justify-between items-center border border-blue-500 shadow-lg shadow-blue-900/20">
                            <div className="text-blue-100"><div className="font-bold flex items-center gap-2"><Icons.Snow className="w-5 h-5"/> Snow Accumulation: {Math.floor(gameState.snowLevel)}%</div><div className="text-xs opacity-75">Operations slowed.</div></div>
                            <button onClick={()=>setModal({type:'chore', job:'snow'})} className="bg-blue-500 hover:bg-blue-400 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition-all">Plow</button>
                        </div>
                    )}

                    <div className="flex gap-4 mb-4">
                         <div className="glass-panel p-4 flex-1 border border-emerald-500/30 bg-emerald-900/10">
                             <div className="text-xs text-emerald-400 font-bold uppercase">Active Deliveries</div>
                             <div className="space-y-1 mt-2">
                                 {(gameState.deliveries||[]).filter(d=>d.at > now).length === 0 && <div className="text-xs text-slate-500 italic">No pending orders</div>}
                                 {(gameState.deliveries||[]).filter(d=>d.at > now).map((d,i) => (
                                     <div key={i} className="flex justify-between text-xs text-white border-b border-white/5 pb-1">
                                         <span>{d.name} {d.qty > 1 ? `(x${d.qty})` : ''}</span>
                                         <span className="font-mono text-emerald-300">{formatTime(d.at - now)}</span>
                                     </div>
                                 ))}
                             </div>
                         </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        {(gameState.fields||[]).filter(f => f.owned).map(f => {
                            const activeJob = getJobProgress(f.id);
                            const cropColor = f.cropPlan && CROPS[f.cropPlan.key] ? CROPS[f.cropPlan.key].color : 'bg-slate-700';
                            
                            return (
                                <div key={f.id} onClick={()=>!activeJob && setModal({type:'field', id:f.id, state: f.state, crop: f.cropPlan ? f.cropPlan.key : null})} 
                                     className="glass-panel p-5 cursor-pointer hover:-translate-y-1 transition-transform group relative overflow-hidden">
                                    <div className={`absolute top-0 right-0 w-24 h-24 rounded-bl-full opacity-10 group-hover:opacity-20 transition-opacity ${cropColor}`}></div>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="font-bold text-white text-lg">#{f.id}</div>
                                        <div className="text-xs font-mono text-slate-500 bg-slate-900/50 px-2 py-1 rounded">{f.acres}ac</div>
                                    </div>
                                    <div className="text-sm text-slate-300 font-medium mb-1">{f.cropPlan ? CROPS[f.cropPlan.key].name : 'Empty'}</div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-3">{f.state}</div>
                                    {activeJob ? (
                                        <div className="mt-2">
                                            <div className="flex justify-between text-[10px] text-amber-400 font-bold mb-1"><span className="uppercase">{activeJob.step}</span> <span className="text-slate-400">({activeJob.empName})</span></div>
                                            <div className="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-amber-500 to-orange-400 progress-bar-striped" style={{width:`${activeJob.pct}%`}}></div></div>
                                        </div>
                                    ) : <div className="text-[10px] text-slate-600 font-mono mt-4">IDLE - TAP TO ASSIGN</div>}
                                </div>
                            )
                        })}
                    </div>
                </div>
            );

            const renderMarket = () => (
                <div className="space-y-6 pb-safe">
                    <h2 className="text-2xl font-bold text-white">Market</h2>
                    
                    {/* Active Contracts */}
                    <div className="glass-panel p-4 border border-blue-500/20">
                        <div className="text-blue-400 font-bold mb-2 text-xs uppercase tracking-wide">Active Contracts</div>
                        {gameState.activeContracts.length === 0 && <div className="text-xs text-slate-500 italic">No active contracts</div>}
                        <div className="space-y-3">
                            {gameState.activeContracts.map(c => {
                                const pct = Math.min(100, (c.delivered / c.qty) * 100);
                                return (
                                    <div key={c.id} className="bg-slate-800/50 p-3 rounded-lg border border-white/5">
                                        <div className="flex justify-between text-white text-xs font-bold mb-1">
                                            <span>{c.buyer} • {c.crop}</span>
                                            <span>{Math.floor(pct)}%</span>
                                        </div>
                                        <div className="w-full h-1.5 bg-slate-700 rounded-full mb-2"><div className="h-full bg-blue-500" style={{width:`${pct}%`}}></div></div>
                                        <div className="flex justify-between items-center">
                                            <div className="text-[10px] text-slate-400">{Math.floor(c.delivered).toLocaleString()} / {c.qty.toLocaleString()} units</div>
                                            <button onClick={()=>deliverContract(c.id, 99999)} className="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold">Deliver</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Available Contracts */}
                    <div className="glass-panel p-4 border border-emerald-500/20">
                        <div className="text-emerald-400 font-bold mb-2 text-xs uppercase tracking-wide">Available Contracts</div>
                        {gameState.contracts.map(c => (
                            <div key={c.id} className="bg-slate-800/50 p-3 rounded-lg mb-2 flex justify-between items-center">
                                <div>
                                    <div className="text-white text-xs font-bold">{c.buyer}</div>
                                    <div className="text-[10px] text-slate-400">{c.qty.toLocaleString()} {c.crop} @ ${c.price.toFixed(2)}</div>
                                </div>
                                <button onClick={()=>signContract(c)} className="bg-emerald-600 text-white px-3 py-1 rounded text-[10px] font-bold">Sign</button>
                            </div>
                        ))}
                    </div>

                     <div className="grid grid-cols-2 gap-4">
                        {Object.keys(CROPS).map(c => (
                            <div key={c} className="bg-slate-800 p-4 rounded-xl">
                                <div className="text-slate-400 text-xs">{c}</div>
                                <div className="text-xl font-bold text-white">${CROPS[c].price.toFixed(2)}</div>
                                <button onClick={()=>setModal({type:'sell_spot', crop:c, price:CROPS[c].price})} className="mt-2 w-full bg-blue-600 text-white text-xs py-2 rounded font-bold">Sell</button>
                            </div>
                        ))}
                     </div>
                </div>
            );
            
            const renderJobs = () => (
                <div className="space-y-4 pb-safe">
                     {gameState.miscTasks.map(t => {
                         const activeJob = getJobProgress(t.id);
                         const isDone = t.status === 'Done';
                         const isSkipped = t.status === 'Skipped';

                         return (
                             <div key={t.id} className={`glass-panel p-4 ${isDone ? 'opacity-50' : ''}`}>
                                 <div className="flex justify-between items-center mb-2">
                                     <div className="text-white font-bold">
                                         {t.name}
                                         <span className="block text-[10px] text-slate-400 font-normal">{t.freq}</span>
                                     </div>
                                     {activeJob ? (
                                         <div className="text-[10px] text-blue-300 text-right">
                                             <div>Working ({activeJob.empName})</div>
                                             <div>{Math.floor(activeJob.pct)}%</div>
                                         </div>
                                     ) : isDone ? (
                                         <div className="text-emerald-400 text-xs font-bold flex items-center gap-1">
                                             <Icons.Check className="w-4 h-4" /> Done
                                         </div>
                                     ) : isSkipped ? (
                                         <div className="text-slate-500 text-xs italic">Seasonal</div>
                                     ) : (
                                         <button onClick={()=>setModal({type:'misc', jobId:t.id})} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Start</button>
                                     )}
                                 </div>
                                 {activeJob && (
                                     <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                         <div className="h-full bg-blue-500 progress-bar-striped" style={{width: `${activeJob.pct}%`}}></div>
                                     </div>
                                 )}
                             </div>
                         );
                     })}
                </div>
            );

            const renderLive = () => (
                <div className="space-y-6 pb-safe">
                    <div className="flex justify-between">
                        <h2 className="text-2xl font-bold text-white">Barns</h2>
                        <button onClick={()=>setModal({type:'build', tab:'live'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">+ Build</button>
                    </div>
                    
                    {/* Fixed: Construction Progress */}
                    {gameState.construction.length > 0 && (
                        <div className="glass-panel p-4 border border-yellow-500/20 bg-yellow-900/10">
                            <div className="text-yellow-400 text-xs font-bold uppercase mb-2">Under Construction</div>
                            {gameState.construction.map((c, i) => {
                                const def = BUILDINGS[c.key];
                                const timeLeft = Math.max(0, c.endTime - now);
                                return (
                                    <div key={i} className="mb-2 last:mb-0">
                                        <div className="flex justify-between text-white text-xs mb-1">
                                            <span>{def.name}</span>
                                            <span className="font-mono">{formatTime(timeLeft)}</span>
                                        </div>
                                        <div className="w-full h-1 bg-slate-700 rounded-full"><div className="h-full bg-yellow-500 progress-bar-striped" style={{width:'100%'}}></div></div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {gameState.facilities.filter(f=>BUILDINGS[f.key] && BUILDINGS[f.key].category==='Livestock').map(f => {
                        const activeJob = getJobProgress(f.id);
                        return (
                            <div key={f.id} className="glass-panel p-4">
                                <div className="text-white font-bold">{BUILDINGS[f.key].name}</div>
                                <div className="text-xs text-slate-400 mb-2">{f.animals ? `${f.animals.count} ${ANIMALS[f.animals.type].name}` : 'Empty'}</div>
                                {f.animals && (
                                    <div className="space-y-2">
                                        <div className="flex gap-2 text-[10px] text-slate-400">
                                            <div className="flex-1 bg-slate-900 rounded p-1 text-center">Feed: {Math.floor(f.feed||0)}%</div>
                                            <div className="flex-1 bg-slate-900 rounded p-1 text-center">Water: {Math.floor(f.water||0)}%</div>
                                        </div>
                                        
                                        {activeJob ? (
                                            <div className="mt-2">
                                                <div className="flex justify-between text-[10px] text-blue-300 mb-1">
                                                    <span>{activeJob.empName} • {activeJob.step}</span>
                                                    <span>{Math.floor(activeJob.pct)}%</span>
                                                </div>
                                                <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 progress-bar-striped" style={{width: `${activeJob.pct}%`}}></div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex gap-2">
                                                <button onClick={()=>setModal({type:'chore', job:'feed', fid:f.id})} className="flex-1 bg-emerald-600 text-white py-2 rounded text-xs font-bold">Feed</button>
                                                <button onClick={()=>setModal({type:'chore', job:'water', fid:f.id})} className="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold">Water</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            );

            const renderStore = () => (
                <div className="space-y-6 pb-safe">
                    <div className="flex gap-2 bg-slate-800 p-1 rounded-lg w-fit">
                        <button onClick={()=>setStoreTab('eq')} className={`px-4 py-2 rounded text-xs font-bold ${storeTab==='eq'?'bg-blue-600 text-white':'text-slate-400'}`}>Equipment</button>
                        <button onClick={()=>setStoreTab('sup')} className={`px-4 py-2 rounded text-xs font-bold ${storeTab==='sup'?'bg-blue-600 text-white':'text-slate-400'}`}>Supplies</button>
                        <button onClick={()=>setStoreTab('bundles')} className={`px-4 py-2 rounded text-xs font-bold ${storeTab==='bundles'?'bg-blue-600 text-white':'text-slate-400'}`}>Bundles</button>
                    </div>
                    {storeTab==='eq' && <div className="grid grid-cols-1 gap-4">
                        {EQUIPMENT.map(e => (
                            <div key={e.id} className="glass-panel p-4 flex justify-between items-center">
                                <div><div className="text-white font-bold">{e.name}</div><div className="text-xs text-slate-500">${e.cost.toLocaleString()}</div></div>
                                <button onClick={()=>buy(e, 'eq')} className="bg-emerald-600 text-white px-4 py-2 rounded text-xs font-bold">Buy</button>
                            </div>
                        ))}
                    </div>}
                    {storeTab==='sup' && <div className="grid grid-cols-2 gap-4">
                        <div className="glass-panel p-4">
                            <div className="text-white font-bold">Diesel Fuel</div>
                            <div className="text-xs text-slate-500">${FUEL_PRICE}/gal</div>
                            <input type="number" value={fuelAmount} onChange={(e)=>setFuelAmount(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-2 mt-2 rounded text-white mb-2" />
                            <button onClick={buyFuel} className="w-full bg-emerald-600 text-white py-2 rounded text-xs font-bold">Order Fuel</button>
                        </div>
                        {Object.entries(SUPPLIES).map(([k,v]) => (
                            <div key={k} className="glass-panel p-4 flex flex-col justify-between">
                                <div><div className="text-white font-bold text-sm leading-tight mb-1">{getSupplyName(k)}</div><div className="text-xs text-slate-500">${v}</div></div>
                                <button onClick={()=>buy({key:k, val:v}, 'sup')} className="mt-2 bg-emerald-600 text-white w-full py-2 rounded text-xs font-bold">Buy</button>
                            </div>
                        ))}
                    </div>}
                    {storeTab==='bundles' && (
                        <div className="space-y-4">
                            <div className="glass-panel p-6 border-l-4 border-purple-500">
                                <h3 className="text-xl font-black text-white">STARTER PACK</h3>
                                <p className="text-slate-400 text-sm mb-4">Includes 1 of every machine, 10 Owned Fields, and resets cash to $5,000.</p>
                                <button onClick={()=>buyBundle('ultimate')} className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-900/20">REDEEM BUNDLE</button>
                            </div>
                        </div>
                    )}
                </div>
            );
            
            const renderReal = () => (
                <div className="space-y-6 pb-safe">
                     <div className="grid grid-cols-2 gap-4">
                         {gameState.fields.map(f => (
                             <div key={f.id} className={`glass-panel p-4 ${f.owned ? 'border-emerald-500/50' : ''}`}>
                                 <div className="text-white font-bold text-lg">#{f.id}</div>
                                 <div className="text-xs text-slate-400">{f.acres} Acres</div>
                                 {!f.owned && <button onClick={()=>buyField(f.id)} className="mt-2 w-full bg-slate-700 text-white py-2 rounded text-xs">Buy</button>}
                             </div>
                         ))}
                     </div>
                </div>
            );

            const renderBank = () => (
                <div className="space-y-6 pb-safe">
                    <div className="glass-panel p-6 border-l-4 border-emerald-500">
                        <div className="text-emerald-400 text-xs font-bold uppercase">Liquid Capital</div>
                        <div className="text-2xl font-mono text-white">${Math.floor(gameState.money).toLocaleString()}</div>
                    </div>
                    {/* Standard Loan Options */}
                    <div className="flex gap-2">
                        <button onClick={()=>loanOp(50000)} className="flex-1 bg-emerald-600 text-white py-3 rounded-lg font-bold">Borrow 50k</button>
                        <button onClick={()=>loanOp(-50000)} className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold">Repay 50k</button>
                    </div>
                    {/* High Value Loan Options */}
                    <div className="flex gap-2">
                        <button onClick={()=>loanOp(1000000)} className="flex-1 bg-emerald-800 text-white py-3 rounded-lg font-bold border border-emerald-500/30">Borrow 1M</button>
                        <button onClick={()=>loanOp(-1000000)} className="flex-1 bg-blue-800 text-white py-3 rounded-lg font-bold border border-blue-500/30">Repay 1M</button>
                    </div>
                    
                    <div className="glass-panel p-4">
                        <h3 className="text-white font-bold mb-4">Recent Transactions</h3>
                        <div className="space-y-2 h-64 overflow-y-auto pr-2">
                            {gameState.transactions.length === 0 && <div className="text-slate-500 text-xs italic">No recent activity</div>}
                            {gameState.transactions.map((t, idx) => (
                                <div key={idx} className="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-white/5">
                                    <div>
                                        <div className="text-white text-xs font-medium">{t.desc}</div>
                                        <div className="text-[10px] text-slate-500">{new Date(t.date).toLocaleTimeString()}</div>
                                    </div>
                                    <div className={`font-mono text-xs font-bold ${t.amount >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {t.amount >= 0 ? '+' : ''}${Math.abs(t.amount).toLocaleString()}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
            
            const renderHR = () => (
                <div className="space-y-6 pb-safe">
                    <h2 className="text-2xl font-bold text-white">Staff</h2>
                    {Object.keys(EMP_ROLES).map(r => (
                        <div key={r} className="glass-panel p-4 flex justify-between items-center">
                            <div className="text-white font-bold">{EMP_ROLES[r].name}</div>
                            <button onClick={()=>hire(r)} className="bg-slate-700 text-white px-4 py-2 rounded text-xs">Hire</button>
                        </div>
                    ))}
                    <div className="space-y-2">
                        {gameState.employees.slice(1).map(e => {
                            const job = gameState.activeJobs.find(j => j.emp == e.id || j.emp2 == e.id);
                            const statusText = job ? `Working: ${job.step || job.task}` : e.status;
                            const weeklyPay = (e.hourlyRate * 40) + (e.hourlyRate * 1.5 * 10);
                            
                            return (
                                <div key={e.id} className="bg-slate-800 p-3 rounded flex justify-between items-center">
                                    <div>
                                        <div className="text-white text-sm font-bold">{e.name} <span className="text-slate-400 font-normal">({e.role})</span></div>
                                        <div className="text-[10px] text-slate-400 mt-1">
                                            ${e.hourlyRate}/hr • Weekly: ${weeklyPay.toLocaleString()} (50h)
                                        </div>
                                        <div className="text-xs text-blue-300 font-mono mt-1">{statusText}</div>
                                    </div>
                                    <button onClick={()=>fireEmployee(e.id)} className="text-red-400 text-xs border border-red-500/30 px-3 py-1 rounded hover:bg-red-900/20">Fire</button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            const renderGarage = () => {
                const stats = getStorageStats();
                return (
                    <div className="space-y-6 pb-safe">
                        <h2 className="text-2xl font-bold text-white">Garage</h2>
                        
                        {/* Machine Storage Card */}
                        <div className="glass-panel p-4 border-l-4 border-purple-500 relative overflow-hidden">
                            <div className="relative z-10 flex justify-between items-end">
                                <div>
                                    <div className="text-purple-400 text-xs font-bold uppercase mb-1">Machine Storage</div>
                                    <div className="text-2xl font-mono text-white">{stats.machineUsed} <span className="text-sm text-slate-400">/ {stats.machineCap} Slots</span></div>
                                </div>
                                <div className="text-right">
                                    <button onClick={()=>setModal({type:'build', category:'Storage'})} className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded font-bold text-xs shadow-lg">+ Build Shed</button>
                                </div>
                            </div>
                            <div className="absolute bottom-0 left-0 h-1 bg-purple-600/30 transition-all duration-1000" style={{width: `${Math.min(100, (stats.machineUsed/stats.machineCap)*100)}%`}}></div>
                        </div>

                        {/* Construction Progress (Storage Only) */}
                        {gameState.construction.filter(c => BUILDINGS[c.key].category === 'Storage').length > 0 && (
                            <div className="glass-panel p-4 border border-yellow-500/20 bg-yellow-900/10">
                                <div className="text-yellow-400 text-xs font-bold uppercase mb-2">Under Construction</div>
                                {gameState.construction.filter(c => BUILDINGS[c.key].category === 'Storage').map((c, i) => {
                                    const def = BUILDINGS[c.key];
                                    const timeLeft = Math.max(0, c.endTime - now);
                                    return (
                                        <div key={i} className="mb-2 last:mb-0">
                                            <div className="flex justify-between text-white text-xs mb-1">
                                                <span>{def.name}</span>
                                                <span className="font-mono">{formatTime(timeLeft)}</span>
                                            </div>
                                            <div className="w-full h-1 bg-slate-700 rounded-full"><div className="h-full bg-yellow-500 progress-bar-striped" style={{width:'100%'}}></div></div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* Fuel Depot Card */}
                        <div className="glass-panel p-4 border-l-4 border-orange-500 relative overflow-hidden">
                            <div className="relative z-10 flex justify-between items-end">
                                <div>
                                    <div className="text-orange-400 text-xs font-bold uppercase mb-1">Fuel Depot</div>
                                    <div className="text-2xl font-mono text-white">{Math.floor(gameState.consumables.diesel || 0).toLocaleString()} <span className="text-sm text-slate-400">gal</span></div>
                                    <div className="text-[10px] text-slate-500 mt-1">Capacity: {stats.fuelCap.toLocaleString()} gal</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-xs text-slate-400 mb-2">${FUEL_PRICE}/gal</div>
                                    <button onClick={()=>setModal({type:'buy_fuel_garage'})} className="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded font-bold text-xs shadow-lg">Order Fuel</button>
                                </div>
                            </div>
                            <div className="absolute bottom-0 left-0 h-1 bg-orange-600/30 transition-all duration-1000" style={{width: `${Math.min(100, (gameState.consumables.diesel/stats.fuelCap)*100)}%`}}></div>
                        </div>

                        <div className="grid grid-cols-1 gap-4">
                            {gameState.inventory.filter(i => i.hours !== undefined).map(i => {
                                const activeJob = getJobProgress(i.uid);
                                return (
                                    <div key={i.uid} className="glass-panel p-4">
                                        <div className="text-white font-bold">{getEq(i.itemId)?.name}</div>
                                        <div className="text-xs text-slate-400">Cond: {Math.floor(i.condition)}%</div>
                                        
                                        {activeJob ? (
                                            <div className="mt-2">
                                                <div className="flex justify-between text-[10px] text-yellow-500 mb-1">
                                                    <span>Servicing... ({activeJob.empName})</span>
                                                    <span>{Math.floor(activeJob.pct)}%</span>
                                                </div>
                                                <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                                    <div className="h-full bg-yellow-600 progress-bar-striped" style={{width: `${activeJob.pct}%`}}></div>
                                                </div>
                                            </div>
                                        ) : (
                                            <button onClick={()=>setModal({type:'maintenance', step:'Service', tid:i.uid, tr:i.uid})} className="mt-2 w-full bg-yellow-600 text-white py-2 rounded text-xs font-bold">Service</button>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

             const renderStorage = () => {
                const stats = getStorageStats();
                const grainPct = Math.min(100, (stats.cropUsed / stats.grainCap) * 100);
                
                return (
                    <div className="space-y-6 pb-safe">
                        <h2 className="text-2xl font-bold text-white">Storage</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="glass-panel p-4">
                                <div className="flex justify-between text-xs text-white font-bold mb-2">
                                    <span>Grain Silos</span>
                                    <span>{Math.floor(grainPct)}%</span>
                                </div>
                                <div className="w-full h-3 bg-slate-700 rounded-full overflow-hidden mb-1">
                                    <div className="h-full bg-yellow-500" style={{width: `${grainPct}%`}}></div>
                                </div>
                                <div className="text-[10px] text-slate-400 text-right">{stats.cropUsed.toLocaleString()} / {stats.grainCap.toLocaleString()} bu</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            {Object.entries(gameState.consumables).map(([k,v]) => (
                                <div key={k} className="bg-slate-800 p-3 rounded">
                                    <div className="text-slate-400 text-xs uppercase">{k}</div>
                                    <div className="text-white font-bold">{Math.floor(v).toLocaleString()}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // --- SETTINGS VIEW ---
            const renderSettings = () => (
                <div className="space-y-6 pb-safe animate-fade-in">
                    <h2 className="text-2xl font-bold text-white">Settings</h2>
                    
                    <div className="glass-panel p-6 space-y-6">
                        <div>
                            <div className="text-slate-400 text-xs uppercase font-bold mb-2">Game Data</div>
                            <button onClick={forceCloudSave} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 mb-3">
                                <Icons.Cloud className="w-5 h-5" />
                                Force Cloud Save
                            </button>
                            <p className="text-[10px] text-slate-500 text-center">Your game saves automatically every 30 seconds.</p>
                        </div>

                        <div className="border-t border-white/10 pt-6">
                            <div className="text-red-400 text-xs uppercase font-bold mb-2">Danger Zone</div>
                            <button onClick={hardReset} className="w-full bg-red-900/50 hover:bg-red-900 text-red-200 border border-red-500/30 font-bold py-4 rounded-xl flex items-center justify-center gap-2">
                                <Icons.Trash className="w-5 h-5" />
                                Hard Reset (Wipe Save)
                            </button>
                        </div>

                        <div className="border-t border-white/10 pt-6">
                            <button onClick={handleLogout} className="w-full text-slate-400 hover:text-white py-2 text-sm">Sign Out</button>
                        </div>
                    </div>
                    
                    <div className="text-center text-[10px] text-slate-600 font-mono">
                        UID: {currentUser.uid}<br/>
                        Version: 26.8 Mobile
                    </div>
                </div>
            );

            // --- MODAL FUNCTION ---
            const renderModalContent = () => {
                if(!modal) return null;
                
                const closeModal = () => setModal(null);
                
                if(modal.type === 'buy_fuel_garage') {
                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-md p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">Order Diesel Fuel</h2>
                                <p className="text-slate-400 mb-2">Current Price: ${FUEL_PRICE}/gal</p>
                                <input type="number" className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-white mb-4" placeholder="Gallons..." value={fuelAmount} onChange={e => setFuelAmount(e.target.value)} />
                                <button onClick={buyFuel} className="w-full bg-orange-600 text-white font-bold py-3 rounded-lg">PURCHASE</button>
                            </div>
                        </div>
                    );
                }

                if(modal.type === 'field') {
                    let nextStep = modal.state;
                    if(modal.state === 'Fallow' || modal.state === 'Stubble') nextStep = 'Primary Tillage';
                    else if(modal.state === 'Ready') nextStep = 'Harvest';
                    else if(modal.state === 'Growing') return null;

                    const req = getJobRequirements('field', nextStep, modal.crop);
                    
                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-lg p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">Field Operation: {nextStep}</h2>
                                <div className="space-y-4">
                                    {req.trCat.length > 0 && (
                                        <RenderSelect 
                                            label="Tractor" 
                                            categories={req.trCat} 
                                            inventory={gameState.inventory} 
                                            activeJobs={gameState.activeJobs} 
                                            selected={modal.selectedTR} 
                                            onChange={v => setModal(p => ({...p, selectedTR: v}))} 
                                        />
                                    )}
                                    {req.impCat.length > 0 && (
                                        <RenderSelect 
                                            label="Implement" 
                                            categories={req.impCat} 
                                            inventory={gameState.inventory} 
                                            activeJobs={gameState.activeJobs} 
                                            selected={modal.selectedImp} 
                                            onChange={v => setModal(p => ({...p, selectedImp: v}))} 
                                        />
                                    )}
                                    <div className="text-slate-400 text-xs font-bold uppercase mt-2">Operator</div>
                                    <select className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg" value={modal.selectedEmp || ""} onChange={e => setModal(p => ({...p, selectedEmp: e.target.value}))}>
                                        <option value="">-- Select Staff --</option>
                                        {gameState.employees.filter(e => req.role.includes(e.role) && e.status === 'Idle').map(e => (
                                            <option key={e.id} value={e.id}>{e.name} ({e.role})</option>
                                        ))}
                                    </select>

                                    {/* Harvest Logistics (Trucks) */}
                                    {req.needsTransport && (
                                        <div className="pt-4 border-t border-white/10">
                                            <div className="text-emerald-400 text-xs font-bold mb-2">TRANSPORT TEAM</div>
                                            <RenderSelect label="Truck/Tractor" categories={['Truck','Tractor']} inventory={gameState.inventory} activeJobs={gameState.activeJobs} selected={modal.selectedTR2} onChange={v => setModal(p => ({...p, selectedTR2: v}))} />
                                            <div className="mt-2"><RenderSelect label="Trailer" categories={['Trailer']} inventory={gameState.inventory} activeJobs={gameState.activeJobs} selected={modal.selectedImp2} onChange={v => setModal(p => ({...p, selectedImp2: v}))} /></div>
                                            <div className="mt-2">
                                                <select className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg" value={modal.selectedEmp2 || ""} onChange={e => setModal(p => ({...p, selectedEmp2: e.target.value}))}>
                                                    <option value="">-- Truck Driver --</option>
                                                    {gameState.employees.filter(e => e.status === 'Idle' && e.id != modal.selectedEmp).map(e => (
                                                        <option key={e.id} value={e.id}>{e.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    )}

                                    <button onClick={() => startFieldJob(modal.id, modal.crop)} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg mt-4">START JOB</button>
                                </div>
                            </div>
                        </div>
                    );
                }

                if(modal.type === 'chore') {
                    const req = getJobRequirements(modal.job === 'snow' ? 'snow' : 'chore', modal.job);
                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-lg p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4 capitalize">{modal.job} Task</h2>
                                <div className="space-y-4">
                                    <RenderSelect label="Machine" categories={req.trCat} inventory={gameState.inventory} activeJobs={gameState.activeJobs} selected={modal.selectedTR} onChange={v => setModal(p => ({...p, selectedTR: v}))} />
                                    {req.impCat.length > 0 && <RenderSelect label="Implement" categories={req.impCat} inventory={gameState.inventory} activeJobs={gameState.activeJobs} selected={modal.selectedImp} onChange={v => setModal(p => ({...p, selectedImp: v}))} />}
                                    
                                    <div className="text-slate-400 text-xs font-bold uppercase mt-2">Worker</div>
                                    <select className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg" value={modal.selectedEmp || ""} onChange={e => setModal(p => ({...p, selectedEmp: e.target.value}))}>
                                        <option value="">-- Select Staff --</option>
                                        {gameState.employees.filter(e => req.role.includes(e.role) && e.status === 'Idle').map(e => (
                                            <option key={e.id} value={e.id}>{e.name} ({e.role})</option>
                                        ))}
                                    </select>
                                    <button onClick={startChore} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">START</button>
                                </div>
                            </div>
                        </div>
                    );
                }

                if(modal.type === 'misc') {
                    const job = MISC_JOBS.find(j => j.id === modal.jobId);
                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-lg p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">{job.name}</h2>
                                <div className="space-y-4">
                                    {job.req && <RenderSelect label="Required Equipment" categories={[job.req]} inventory={gameState.inventory} activeJobs={gameState.activeJobs} selected={modal.selectedTR} onChange={v => setModal(p => ({...p, selectedTR: v}))} />}
                                    <div className="text-slate-400 text-xs font-bold uppercase mt-2">Assign Worker</div>
                                    <select className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg" value={modal.selectedEmp || ""} onChange={e => setModal(p => ({...p, selectedEmp: e.target.value}))}>
                                        <option value="">-- Select Staff --</option>
                                        {gameState.employees.filter(e => (e.role === job.role || e.role === 'Hand') && e.status === 'Idle').map(e => (
                                            <option key={e.id} value={e.id}>{e.name} ({e.role})</option>
                                        ))}
                                    </select>
                                    <button onClick={startMiscJob} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">START WORK</button>
                                </div>
                            </div>
                        </div>
                    );
                }

                if(modal.type === 'maintenance') {
                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-lg p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">Equipment Service</h2>
                                <div className="space-y-4">
                                    <div className="text-slate-400 text-xs font-bold uppercase mt-2">Assign Mechanic</div>
                                    <select className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg" value={modal.selectedEmp || ""} onChange={e => setModal(p => ({...p, selectedEmp: e.target.value}))}>
                                        <option value="">-- Select Mechanic --</option>
                                        {gameState.employees.filter(e => e.role === 'Mech' && e.status === 'Idle').map(e => (
                                            <option key={e.id} value={e.id}>{e.name}</option>
                                        ))}
                                    </select>
                                    <button onClick={startMaintenance} className="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg">START SERVICE (${SERVICE_COST})</button>
                                </div>
                            </div>
                        </div>
                    );
                }

                if(modal.type === 'sell_spot') {
                    return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-md p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">Sell {modal.crop}</h2>
                                <p className="text-slate-400 mb-4">Current Price: ${modal.price.toFixed(2)}</p>
                                <input type="number" className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-white mb-4" placeholder="Amount to sell..." value={sellAmount} onChange={e => setSellAmount(e.target.value)} />
                                <button onClick={() => sellSpot(modal.crop)} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg">CONFIRM SALE</button>
                            </div>
                        </div>
                    );
                }
                
                // --- DYNAMIC BUILD MODAL ---
                if(modal.type === 'build') {
                     // Filter buildings based on category passed in modal props or default to Livestock
                     const category = modal.category || 'Livestock';
                     const title = category === 'Storage' ? 'Build Shed' : 'Build Barn';
                     
                     return (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                            <div className="glass-panel w-full max-w-md p-6 relative" onClick={e=>e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">{title}</h2>
                                <div className="space-y-2">
                                    {Object.keys(BUILDINGS).filter(k=>BUILDINGS[k].category===category).map(k => (
                                        <button key={k} onClick={()=>{
                                            const cost = BUILDINGS[k].cost;
                                            if(gameState.money < cost) return alert("Insufficient Funds");
                                            setGameState(p => ({...p, money: p.money-cost, construction: [...p.construction, {id: Math.random(), key:k, endTime: Date.now() + BUILDINGS[k].buildTime}] }));
                                            closeModal();
                                        }} className="w-full bg-slate-800 p-3 rounded flex justify-between text-white hover:bg-slate-700">
                                            <span>{BUILDINGS[k].name}</span>
                                            <span className="text-emerald-400">${BUILDINGS[k].cost.toLocaleString()}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                        <div className="glass-panel p-6">
                            <h2 className="text-white font-bold">Menu</h2>
                            <button onClick={closeModal} className="mt-4 bg-slate-700 text-white px-4 py-2 rounded">Close</button>
                        </div>
                    </div>
                );
            };

            // RENDER
            if (isLoading) return <div className="h-screen flex items-center justify-center text-white font-black animate-pulse">CONNECTING...</div>;
            if (!currentUser) return <AuthGate onLogin={()=>{}} />;

            return (
                <div className="flex flex-col lg:flex-row h-full bg-[#020617]">
                    {/* Desktop Sidebar */}
                    <div className="hidden lg:flex w-64 bg-slate-900/90 backdrop-blur-xl border-r border-white/5 flex-col justify-between p-4 z-20 h-full">
                        <div className="space-y-8">
                            <div className="flex items-center gap-3 px-2">
                                <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                                    <Icons.Tractor className="text-white w-6 h-6"/>
                                </div>
                                <div>
                                    <span className="font-black text-xl text-white tracking-tight">JERSEY<br/><span className="text-blue-400">ROOTS</span></span>
                                    <div className="text-[10px] text-emerald-400 flex items-center gap-1 font-bold mt-1"><Icons.Cloud className="w-3 h-3"/> CLOUD SYNCED</div>
                                </div>
                            </div>
                            <nav className="space-y-2">
                                {['Dashboard', 'Market', 'Jobs', 'Livestock', 'Store', 'Real Estate'].map(v => {
                                    const key = v.toLowerCase().replace(' ','');
                                    return (
                                        <button key={v} onClick={() => setView(key)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group ${view === key ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                                            <span className="font-bold text-sm">{v}</span>
                                        </button>
                                    )
                                })}
                                <button onClick={() => setView('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group ${view === 'settings' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                                    <span className="font-bold text-sm">Settings</span>
                                </button>
                            </nav>
                        </div>
                    </div>

                    {/* Mobile Nav Overlay */}
                    <MobileNav currentView={view} setView={setView} menuOpen={menuOpen} setMenuOpen={setMenuOpen} />

                    {/* Main Content */}
                    <div className="flex-1 overflow-y-auto relative h-full no-scrollbar">
                        <div className="max-w-7xl mx-auto p-4 pb-40 lg:p-10 lg:pb-10">
                            {view === 'dashboard' && renderDash()}
                            {view === 'market' && renderMarket()}
                            {view === 'jobs' && renderJobs()}
                            {view === 'livestock' && renderLive()}
                            {view === 'store' && renderStore()}
                            {view === 'realestate' && renderReal()}
                            {view === 'garage' && renderGarage()}
                            {view === 'bank' && renderBank()}
                            {view === 'hr' && renderHR()}
                            {view === 'storage' && renderStorage()}
                            {view === 'settings' && renderSettings()}
                        </div>
                    </div>
                    
                    {renderModalContent()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
